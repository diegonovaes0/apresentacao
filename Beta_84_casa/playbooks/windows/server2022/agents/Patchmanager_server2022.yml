---
- name: InstalaÃ§Ã£o do Patchmanager no Windows Server
  hosts: windows
  vars:
    installation_code: us_dbbaa0d164ea2cf1caddc8ba13a4dd43
    patchmanager_file: "{{ lookup('env', 'PATCHMANAGER_FILE') | default('PM_OPERIMPLANTAO_Agent.exe', true) }}"
    caminho_remoto_patchmanager: C:\Users\_admin-skyone\Desktop\Agents_Skyone\patchmanager\{{ patchmanager_file }}
    arquivos_dir: "./arquivos/windows"

  tasks:
    - name: Criar diretÃ³rio para patchmanagerğŸ”´ğŸ› ï¸
      win_file:
        path: C:\Users\_admin-skyone\Desktop\Agents_Skyone\patchmanager
        state: directory
      ignore_errors: yes

    - name: Copiar arquivo bin para o servidorğŸ”´ğŸ› ï¸
      win_copy:
        src: "{{ arquivos_dir }}/{{ patchmanager_file }}"
        dest: "{{ caminho_remoto_patchmanager }}"
      ignore_errors: yes

    - name: Iniciar instalaÃ§Ã£o do PatchManagerğŸ”´ğŸ› ï¸
      win_shell: |
        Start-Process -FilePath "{{ caminho_remoto_patchmanager }}" -ArgumentList "/silent" -Wait
      ignore_errors: yes

    - name: Verificar se a instalaÃ§Ã£o do PatchManager foi concluÃ­da com sucessoğŸ”´ğŸ› ï¸
      win_shell: |
        if (Test-Path 'C:\Program Files\PatchManager') { 
          Write-Output "InstalaÃ§Ã£o concluÃ­da com sucesso" 
        } else { 
          Write-Output "Falha na instalaÃ§Ã£o" 
        }
      register: install_check
      ignore_errors: yes

    - name: Mostrar resultado da verificaÃ§Ã£o da instalaÃ§Ã£o do PatchManagerğŸ”´ğŸ› ï¸
      debug:
        var: install_check.stdout_lines
      ignore_errors: yes

    - name: Limpar arquivos temporÃ¡rios do PatchManagerğŸ”´ğŸ› ï¸
      win_file:
        path: "{{ caminho_remoto_patchmanager }}"
        state: absent
      ignore_errors: yes